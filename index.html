<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist@5/swagger-ui.css">
    <title>Federation Config API Explorer (GET only)</title>
    <style>
        body { margin: 0; background: #fafafa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow-x: hidden; }

        /* Header */
        .header { background: #003e67; color: white; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #002a46; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .controls { display: flex; align-items: center; gap: 12px; }
        #search-bar, #auth-token { padding: 8px 12px; width: 180px; border-radius: 4px; border: none; outline: none; font-size: 13px; }

        /* Token Status Badge */
        #token-status { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 3px; display: none; }
        .status-expired { background: #c23934; color: white; }

        .btn-clear { background: transparent; color: #ff9a9a; border: 1px solid #ff9a9a; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; margin-left: -45px; z-index: 5; }
        .btn-clear:hover { background: #ff9a9a; color: #003e67; }

        .btn-view { padding: 8px 12px; background: #f3f2f2; color: #003e67; border: 1px solid #d8dde6; border-radius: 4px; cursor: pointer; font-weight: bold; display: none; }

        /* Side Panel Action Buttons */
        .btn-action { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; transition: 0.2s; }
        .btn-csv { background: #4bca81; color: white; }
        .btn-csv:hover { background: #37a868; }
        .btn-copy { background: #0070d2; color: white; }
        .btn-copy:hover { background: #005fb2; }

        /* Side Panel / Drawer */
        #side-panel {
            position: fixed; right: -90%; top: 0; width: 60%; height: 100%;
            background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.2);
            transition: right 0.3s ease-out; z-index: 1000;
            display: flex; flex-direction: column;
            min-width: 300px; max-width: 95%;
        }
        #side-panel.open { right: 0; }
        #resizer { width: 8px; cursor: ew-resize; background: #d8dde6; position: absolute; left: 0; top: 0; bottom: 0; transition: background 0.2s; }
        #resizer:hover { background: #0070d2; }

        .panel-header { padding: 10px 25px; background: #f3f2f2; border-bottom: 1px solid #d8dde6; }
        .panel-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .panel-content { flex-grow: 1; overflow: auto; background: #fff; padding: 0; }

        /* Table & JSON Styling */
        .data-grid { width: 100%; border-collapse: collapse; font-size: 11px; text-align: left; }
        .data-grid th { background: #f4f6f9; color: #514f4d; padding: 10px; border: 1px solid #d8dde6; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
        .data-grid td { padding: 8px 10px; border: 1px solid #d8dde6; color: #16325c; white-space: nowrap; font-family: 'SFMono-Regular', Consolas, monospace; }
        .data-grid tr:hover { background-color: #faffbd; }
        .hidden-row { display: none; }

        #json-view { padding: 20px; font-family: 'SFMono-Regular', Consolas, monospace; font-size: 12px; line-height: 1.4; color: #c23934; white-space: pre-wrap; background: #fafafa; display: none; margin: 0; }

        .toggle-group { display: flex; background: #ecebea; border-radius: 4px; padding: 2px; border: 1px solid #d8dde6; }
        .toggle-btn { padding: 4px 12px; border: none; background: transparent; cursor: pointer; font-size: 11px; font-weight: bold; border-radius: 3px; color: #706e6b; }
        .toggle-btn.active { background: white; color: #0070d2; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.3); display:none; z-index: 999; }
        #overlay.active { display:block; }
    </style>
</head>
<body>

<div class="header">
    <div class="controls">
        <h2 style="margin:0; font-size: 1rem;">Symphony Explorer</h2>
        <input type="text" id="search-bar" placeholder="Filter endpoints..." onkeyup="filterEndpoints()">
    </div>
    <div class="controls">
        <div id="token-status" class="status-expired">EXPIRED / UNAUTHORIZED</div>
        <div style="position: relative; display: flex; align-items: center;">
            <input type="password" id="auth-token" placeholder="Bearer Token..." oninput="saveToken()">
            <button class="btn-clear" onclick="clearToken()">‚úñ</button>
        </div>
        <button class="btn-view" id="open-panel-btn" onclick="togglePanel(true)">üëÅÔ∏è Show Data</button>
    </div>
</div>

<div id="overlay" onclick="togglePanel(false)"></div>

<div id="side-panel">
    <div id="resizer"></div>
    <div class="panel-header">
        <div class="panel-toolbar">
            <div style="display:flex; align-items: center; gap:15px;">
                <h3 style="margin:0; font-size: 1rem;">Data View <span id="row-count" style="font-weight:normal; font-size:11px; color:#706e6b;"></span></h3>
                <div class="toggle-group">
                    <button id="btn-grid" class="toggle-btn active" onclick="setView('grid')">GRID</button>
                    <button id="btn-json" class="toggle-btn" onclick="setView('json')">JSON</button>
                </div>
                <button id="dl-btn" class="btn-action btn-csv" onclick="downloadCsv()">üíæ Download CSV</button>
                <button id="copy-btn" class="btn-action btn-copy" onclick="copyJsonToClipboard()" style="display:none;">üìã Copy JSON</button>
            </div>
            <button onclick="togglePanel(false)" style="cursor:pointer; border:none; background:#c23934; color:white; padding:6px 12px; border-radius:4px; font-weight:bold;">Close √ó</button>
        </div>
        <div id="filter-container" style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="local-filter" placeholder="Filter grid results..." onkeyup="localTableFilter()"
                   style="padding: 6px; width: 250px; border: 1px solid #ddd; font-size: 12px; border-radius: 4px;">
            <span id="filter-status" style="font-size: 11px; color: #706e6b;"></span>
        </div>
    </div>
    <div class="panel-content">
        <div id="grid-view"></div>
        <pre id="json-view"></pre>
    </div>
</div>

<div id="swagger-ui"></div>

<script src="data.js"></script>
<script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-bundle.js"></script>

<script>
    const rawSpec = swaggerData;
    let processedRows = [];
    let lastRawJson = null;

    // --- Token Helpers ---
    function saveToken() {
        sessionStorage.setItem('symphony_bearer', document.getElementById('auth-token').value);
        document.getElementById('token-status').style.display = 'none'; // Clear status on edit
    }
    function clearToken() {
        document.getElementById('auth-token').value = '';
        sessionStorage.removeItem('symphony_bearer');
        document.getElementById('token-status').style.display = 'none';
    }
    function loadToken() {
        const saved = sessionStorage.getItem('symphony_bearer');
        if (saved) document.getElementById('auth-token').value = saved;
    }

    // --- Panel & View Logic ---
    function setView(vt) {
        document.getElementById('grid-view').style.display = vt === 'grid' ? 'block' : 'none';
        document.getElementById('json-view').style.display = vt === 'json' ? 'block' : 'none';
        document.getElementById('dl-btn').style.display = vt === 'grid' ? 'block' : 'none';
        document.getElementById('copy-btn').style.display = vt === 'json' ? 'block' : 'none';
        document.getElementById('btn-grid').classList.toggle('active', vt === 'grid');
        document.getElementById('btn-json').classList.toggle('active', vt === 'json');
        document.getElementById('filter-container').style.visibility = vt === 'grid' ? 'visible' : 'hidden';
        if (vt === 'json' && lastRawJson) document.getElementById('json-view').textContent = JSON.stringify(lastRawJson, null, 2);
    }

    function togglePanel(isOpen) {
        document.getElementById('side-panel').classList.toggle('open', isOpen);
        document.getElementById('overlay').classList.toggle('active', isOpen);
    }

    function flattenObject(obj, prefix = '') {
        return Object.keys(obj).reduce((acc, k) => {
            const pre = prefix.length ? prefix + '.' : '';
            if (obj[k] !== null && typeof obj[k] === 'object' && !Array.isArray(obj[k])) {
                Object.assign(acc, flattenObject(obj[k], pre + k));
            } else if (Array.isArray(obj[k])) {
                acc[pre + k] = JSON.stringify(obj[k]);
            } else { acc[pre + k] = obj[k]; }
            return acc;
        }, {});
    }

    function updateGridPreview(jsonResponse) {
        lastRawJson = jsonResponse;
        const rawData = jsonResponse.items || jsonResponse.contacts || jsonResponse.entitlements || jsonResponse.flags || jsonResponse.data || jsonResponse;
        const isArray = Array.isArray(rawData);
        const array = isArray ? rawData : [rawData];
        processedRows = array.map(row => flattenObject(row));
        const allKeys = [...new Set(processedRows.flatMap(row => Object.keys(row)))];
        document.getElementById('row-count').textContent = `(${processedRows.length} rows)`;

        let html = `<table class="data-grid"><thead><tr>`;
        allKeys.forEach(k => html += `<th>${k}</th>`);
        html += `</tr></thead><tbody>`;
        processedRows.forEach(row => {
            html += `<tr>`;
            allKeys.forEach(k => html += `<td title='${String(row[k]??'')}'>${row[k]??''}</td>`);
            html += `</tr>`;
        });
        document.getElementById('grid-view').innerHTML = html + `</tbody></table>`;
        document.getElementById('open-panel-btn').style.display = 'block';
        setView(isArray ? 'grid' : 'json');
        togglePanel(true);
    }

    // --- Resizer ---
    const panel = document.getElementById('side-panel');
    let isResizing = false;
    document.getElementById('resizer').addEventListener('mousedown', () => { isResizing = true; document.body.style.cursor = 'ew-resize'; });
    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        let newWidth = window.innerWidth - e.clientX;
        if (newWidth > 300 && newWidth < window.innerWidth * 0.95) panel.style.width = `${newWidth}px`;
    });
    document.addEventListener('mouseup', () => { isResizing = false; document.body.style.cursor = 'default'; });

    // --- Export ---
    function downloadCsv() {
        const keys = [...new Set(processedRows.flatMap(row => Object.keys(row)))];
        const csv = [keys.join(','), ...processedRows.map(row => keys.map(k => `"${String(row[k]??'').replace(/"/g, '""')}"`).join(','))].join('\r\n');
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
        link.download = `symphony_export.csv`;
        link.click();
    }

    function copyJsonToClipboard() {
        navigator.clipboard.writeText(JSON.stringify(lastRawJson, null, 2)).then(() => {
            const btn = document.getElementById('copy-btn');
            const original = btn.innerHTML;
            btn.innerHTML = "‚úÖ Copied!";
            setTimeout(() => btn.innerHTML = original, 2000);
        });
    }

    function localTableFilter() {
        const term = document.getElementById('local-filter').value.toLowerCase();
        const rows = document.querySelectorAll('.data-grid tbody tr');
        let count = 0;
        rows.forEach(row => {
            const m = row.textContent.toLowerCase().includes(term);
            row.classList.toggle('hidden-row', !m);
            if (m) count++;
        });
        document.getElementById('filter-status').textContent = term ? `Found ${count}` : '';
    }

    // --- Swagger Initialization ---
    function renderSwagger(specData) {
        window.ui = SwaggerUIBundle({
            spec: specData,
            dom_id: '#swagger-ui',
            presets: [SwaggerUIBundle.presets.apis],
            defaultModelsExpandDepth: -1,
            requestInterceptor: (req) => {
                const t = document.getElementById('auth-token').value.trim();
                if (t) req.headers['Authorization'] = 'Bearer ' + t;
                return req;
            },
            responseInterceptor: (res) => {
                if (res.status === 401 || res.status === 403) {
                    document.getElementById('token-status').style.display = 'block';
                } else if (res.ok && res.obj) {
                    document.getElementById('token-status').style.display = 'none';
                    updateGridPreview(res.obj);
                }
                return res;
            }
        });
    }

    function filterEndpoints() {
        const term = document.getElementById('search-bar').value.toLowerCase();
        const filtered = JSON.parse(JSON.stringify(rawSpec));
        const newPaths = {};
        const activeTags = new Set();
        const lookup = (ref) => {
            const parts = ref.replace('#/', '').split('/');
            let current = rawSpec;
            for (const part of parts) { if (!current[part]) return null; current = current[part]; }
            return current;
        };
        const dereference = (obj) => {
            if (!obj || typeof obj !== 'object') return obj;
            if (obj['$ref']) return dereference(lookup(obj['$ref']));
            for (const key in obj) { obj[key] = dereference(obj[key]); }
            return obj;
        };
        Object.entries(rawSpec.paths).forEach(([path, methods]) => {
            if (path.toLowerCase().includes('/config') && path.toLowerCase().includes(term) && methods.get) {
                newPaths[path] = { get: dereference(JSON.parse(JSON.stringify(methods.get))) };
                if (methods.get.tags) methods.get.tags.forEach(tag => activeTags.add(tag));
            }
        });
        filtered.paths = newPaths;
        if (filtered.tags) filtered.tags = filtered.tags.filter(t => activeTags.has(t.name));
        renderSwagger(filtered);
    }

    window.onload = () => { loadToken(); filterEndpoints(); };
</script>
</body>
</html>
